<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âš¡ Nifty 50 Dashboard | AWS Edition</title>
    <style>
        body {
            background-color: #0b0f19;
            color: #e2e8f0;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: 40px 20px;
        }

        .container {
            max-width: 1300px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #1e293b;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }

        .title {
            font-size: 28px;
            font-weight: 800;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
        }

        .timestamp {
            font-size: 15px;
            color: #94a3b8;
            background: #1e293b;
            padding: 8px 16px;
            border-radius: 20px;
            display: flex;
            align-items: center;
        }

        .live-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background-color: #22c55e;
            border-radius: 50%;
            margin-right: 10px;
            box-shadow: 0 0 10px #22c55e;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.3);
                opacity: 0.5;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 40px;
            background-color: #111827;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.3);
        }

        th,
        td {
            padding: 14px 16px;
            text-align: center;
            border-bottom: 1px solid #1f2937;
        }

        th {
            background-color: #1f2937;
            color: #9ca3af;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 1px;
            font-weight: 600;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background-color: #1e293b;
            transition: all 0.2s ease;
        }

        .table-title {
            background-color: #0f172a;
            padding: 16px 20px;
            font-weight: 700;
            color: #f8fafc;
            text-align: left;
            font-size: 16px;
            border-bottom: 2px solid #3b82f6;
        }

        .buy-pe {
            color: #ef4444;
            font-weight: 800;
            text-shadow: 0 0 8px rgba(239, 68, 68, 0.3);
        }

        .buy-ce {
            color: #10b981;
            font-weight: 800;
            text-shadow: 0 0 8px rgba(16, 185, 129, 0.3);
        }

        .val-strike {
            color: #ca8a04;
        }

        .val-call {
            color: #10b981;
        }

        .val-put {
            color: #ef4444;
        }

        .highlight-tv {
            background-color: rgba(239, 68, 68, 0.15) !important;
            color: #fca5a5 !important;
            animation: pulse-border 1.5s infinite;
            border: 2px solid #ef4444 !important;
            border-radius: 6px;
        }

        @keyframes pulse-border {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.5);
            }

            70% {
                box-shadow: 0 0 0 8px rgba(239, 68, 68, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        #summary-banner {
            display: flex;
            justify-content: space-around;
            background: #111827;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #1f2937;
        }

        .stat-box {
            text-align: center;
        }

        .stat-title {
            font-size: 12px;
            color: #9ca3af;
            text-transform: uppercase;
            font-weight: bold;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 800;
        }

        .pos-color {
            color: #10b981;
        }

        .neg-color {
            color: #ef4444;
        }

        .neu-color {
            color: #94a3b8;
        }

        #error-banner {
            display: none;
            background: #7f1d1d;
            color: white;
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="title">âš¡ AWS Nifty 50 Equidistant Dashboard</div>
            <div class="timestamp">
                <span class="live-indicator" id="pulse-dot"></span>
                <span id="time">Connecting to Server...</span>
            </div>
        </div>

        <div id="summary-banner">
            <div class="stat-box">
                <div class="stat-title">POSITIVE STOCKS</div>
                <div class="stat-value pos-color" id="pos-stat">0 | 0.0%</div>
            </div>
            <div class="stat-box">
                <div class="stat-title">NEGATIVE STOCKS</div>
                <div class="stat-value neg-color" id="neg-stat">0 | 0.0%</div>
            </div>
            <div class="stat-box">
                <div class="stat-title">NEUTRAL STOCKS</div>
                <div class="stat-value neu-color" id="neu-stat">0 | 0.0%</div>
            </div>
        </div>

        <div id="error-banner">Connecting to local WebSocket stream...</div>
        <div id="tables-container"></div>
    </div>

    <script>
        const playBeep = () => {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if (audioCtx.state === 'suspended') return;
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(880, audioCtx.currentTime); // A5 note
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                oscillator.start();
                setTimeout(() => oscillator.stop(), 200);
            } catch (e) { }
        };

        const connectWebSocket = () => {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws_nifty`;
            const ws = new WebSocket(wsUrl);
            let alertedSet = new Set();

            const container = document.getElementById('tables-container');
            const timeEl = document.getElementById('time');
            const errorBanner = document.getElementById('error-banner');
            const pulse = document.getElementById('pulse-dot');

            ws.onopen = () => {
                errorBanner.style.display = 'none';
                pulse.style.backgroundColor = '#22c55e';
                pulse.style.boxShadow = '0 0 10px #22c55e';
                timeEl.innerText = "Connected! Awaiting data...";
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                timeEl.innerText = `Live | ${data.timestamp}`;

                if (data.summary) {
                    document.getElementById('pos-stat').innerText = `${data.summary.pos_count} | ${data.summary.pos_weight}%`;
                    document.getElementById('neg-stat').innerText = `${data.summary.neg_count} | ${data.summary.neg_weight}%`;
                    document.getElementById('neu-stat').innerText = `${data.summary.neu_count} | ${data.summary.neu_weight}%`;
                }

                let html = '';
                let shouldBeep = false;
                data.indices.forEach(idx => {
                    html += `
                        <table>
                            <tr>
                                <td colspan="11" class="table-title">${idx.name} (Spot: ${idx.spot} | Exp: ${idx.expiry} | Weight: ${idx.weight}%)</td>
                            </tr>
                            <tr>
                                <th>Strikes</th>
                                <th>CE Strike</th><th>CE LTP</th><th>CE IV</th><th>CE TV</th>
                                <th>PE Strike</th><th>PE LTP</th><th>PE IV</th><th>PE TV</th>
                                <th>TV Diff (CE-PE)</th><th>BIAS</th>
                            </tr>
                    `;

                    idx.rows.forEach(row => {
                        let biasHtml = row.bias === 'BUY CE'
                            ? `<span class="buy-ce">BUY CE</span>`
                            : row.bias === 'BUY PE' ? `<span class="buy-pe">BUY PE</span>` : '-';

                        const uniqueKeyCE = idx.name + '_' + row.ce_strike + '_CE';
                        const uniqueKeyPE = idx.name + '_' + row.pe_strike + '_PE';

                        if (row.ce_tv <= 0) {
                            if (!alertedSet.has(uniqueKeyCE)) { alertedSet.add(uniqueKeyCE); shouldBeep = true; }
                        } else { alertedSet.delete(uniqueKeyCE); }

                        if (row.pe_tv <= 0) {
                            if (!alertedSet.has(uniqueKeyPE)) { alertedSet.add(uniqueKeyPE); shouldBeep = true; }
                        } else { alertedSet.delete(uniqueKeyPE); }

                        let ceTvHtml = row.ce_tv <= 0 ? `<td style="font-weight:bold;" class="highlight-tv">${row.ce_tv} ðŸ””ä¹°</td>` : `<td style="font-weight:bold;">${row.ce_tv}</td>`;
                        let peTvHtml = row.pe_tv <= 0 ? `<td style="font-weight:bold;" class="highlight-tv">${row.pe_tv} ðŸ””ä¹°</td>` : `<td style="font-weight:bold;">${row.pe_tv}</td>`;

                        html += `
                            <tr>
                                <td style="font-weight: bold; color: #cbd5e1;">${row.pair}</td>
                                <td class="val-strike">${row.ce_strike}</td><td class="val-call">${row.ce_ltp}</td><td>${row.ce_iv}</td>${ceTvHtml}
                                <td class="val-strike">${row.pe_strike}</td><td class="val-put">${row.pe_ltp}</td><td>${row.pe_iv}</td>${peTvHtml}
                                <td>${row.diff}</td>
                                <td>${biasHtml}</td>
                            </tr>
                        `;
                    });
                    html += `</table>`;
                });

                if (shouldBeep) playBeep();

                container.innerHTML = html;
            };

            ws.onclose = () => {
                timeEl.innerText = "Connection Lost. Retrying...";
                pulse.style.backgroundColor = '#ef4444';
                pulse.style.boxShadow = '0 0 10px #ef4444';
                errorBanner.style.display = 'block';
                setTimeout(connectWebSocket, 3000);
            };
        };

        // Start connection
        connectWebSocket();
    </script>
</body>

</html>