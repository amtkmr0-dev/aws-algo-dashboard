<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ö° Nifty 50 Dashboard | AWS Edition</title>
    <style>
        body {
            background-color: #0b0f19;
            color: #e2e8f0;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: 40px 20px;
        }

        .container {
            max-width: 1300px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #1e293b;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }

        .title {
            font-size: 28px;
            font-weight: 800;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
        }

        .timestamp {
            font-size: 15px;
            color: #94a3b8;
            background: #1e293b;
            padding: 8px 16px;
            border-radius: 20px;
            display: flex;
            align-items: center;
        }

        .live-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background-color: #22c55e;
            border-radius: 50%;
            margin-right: 10px;
            box-shadow: 0 0 10px #22c55e;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.3);
                opacity: 0.5;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 40px;
            background-color: #111827;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.3);
        }

        th,
        td {
            padding: 14px 16px;
            text-align: center;
            border-bottom: 1px solid #1f2937;
        }

        th {
            background-color: #1f2937;
            color: #9ca3af;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 1px;
            font-weight: 600;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background-color: #1e293b;
            transition: all 0.2s ease;
        }

        .table-title {
            background-color: #0f172a;
            padding: 16px 20px;
            font-weight: 700;
            color: #f8fafc;
            text-align: left;
            font-size: 16px;
            border-bottom: 2px solid #3b82f6;
        }

        .buy-pe {
            color: #ef4444;
            font-weight: 800;
            text-shadow: 0 0 8px rgba(239, 68, 68, 0.3);
        }

        .buy-ce {
            color: #10b981;
            font-weight: 800;
            text-shadow: 0 0 8px rgba(16, 185, 129, 0.3);
        }

        .val-strike {
            color: #ca8a04;
        }

        .val-call {
            color: #10b981;
        }

        .val-put {
            color: #ef4444;
        }

        .highlight-tv {
            background-color: rgba(239, 68, 68, 0.15) !important;
            color: #fca5a5 !important;
            animation: pulse-border 1.5s infinite;
            border: 2px solid #ef4444 !important;
            border-radius: 6px;
        }

        @keyframes pulse-border {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.5);
            }

            70% {
                box-shadow: 0 0 0 8px rgba(239, 68, 68, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        .best-trade {
            background: linear-gradient(45deg, #d97706, #fbbf24) !important;
            color: #111827 !important;
            font-weight: 900 !important;
            border-radius: 8px;
            border: 2px solid #fef08a !important;
            animation: pulse-gold 1.5s infinite;
            text-shadow: none;
            box-shadow: 0 0 10px #fbbf24;
        }

        @keyframes pulse-gold {
            0% {
                box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(251, 191, 36, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(251, 191, 36, 0);
            }
        }

        #summary-banner {
            display: flex;
            justify-content: space-around;
            background: #111827;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #1f2937;
        }

        .stat-box {
            text-align: center;
        }

        .stat-title {
            font-size: 12px;
            color: #9ca3af;
            text-transform: uppercase;
            font-weight: bold;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 800;
        }

        .pos-color {
            color: #10b981;
        }

        .neg-color {
            color: #ef4444;
        }

        .neu-color {
            color: #94a3b8;
        }

        #error-banner {
            display: none;
            background: #7f1d1d;
            color: white;
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .filter-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .filter-btn {
            background-color: #1e293b;
            color: #cbd5e1;
            border: 1px solid #3b82f6;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-btn:hover {
            background-color: #2563eb;
            color: #ffffff;
        }

        .filter-btn.active {
            background-color: #3b82f6;
            color: #ffffff;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="title">‚ö° AWS Nifty 50 Equidistant Dashboard</div>
            <div class="timestamp">
                <span class="live-indicator" id="pulse-dot"></span>
                <span id="time">Connecting to Server...</span>
            </div>
        </div>

        <div id="summary-banner">
            <div class="stat-box">
                <div class="stat-title">POSITIVE STOCKS</div>
                <div class="stat-value pos-color" id="pos-stat">0 | 0.0%</div>
            </div>
            <div class="stat-box">
                <div class="stat-title">NEGATIVE STOCKS</div>
                <div class="stat-value neg-color" id="neg-stat">0 | 0.0%</div>
            </div>
            <div class="stat-box">
                <div class="stat-title">NEUTRAL STOCKS</div>
                <div class="stat-value neu-color" id="neu-stat">0 | 0.0%</div>
            </div>
        </div>

        <div class="filter-container">
            <button class="filter-btn active" onclick="setFilter('ALL')" id="filter-ALL">SHOW ALL</button>
            <button class="filter-btn" onclick="setFilter('POSITIVE')" id="filter-POSITIVE">POSITIVE</button>
            <button class="filter-btn" onclick="setFilter('NEGATIVE')" id="filter-NEGATIVE">NEGATIVE</button>
            <button class="filter-btn" onclick="setFilter('NEUTRAL')" id="filter-NEUTRAL">NEUTRAL</button>
        </div>

        <div id="error-banner">Connecting to local WebSocket stream...</div>
        <div id="tables-container"></div>
    </div>

    <script>
        let currentFilter = 'ALL';
        
        function setFilter(filterType) {
            currentFilter = filterType;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('filter-' + filterType).classList.add('active');
            if(window.lastData) renderData(window.lastData);
        }
        
        const playBeep = () => {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if (audioCtx.state === 'suspended') return;
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(880, audioCtx.currentTime); // A5 note
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                oscillator.start();
                setTimeout(() => oscillator.stop(), 200);
            } catch (e) { }
        };

        const connectWebSocket = () => {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws_nifty`;
            const ws = new WebSocket(wsUrl);
            let alertedSet = new Set();

            const container = document.getElementById('tables-container');
            const timeEl = document.getElementById('time');
            const errorBanner = document.getElementById('error-banner');
            const pulse = document.getElementById('pulse-dot');

            ws.onopen = () => {
                errorBanner.style.display = 'none';
                pulse.style.backgroundColor = '#22c55e';
                pulse.style.boxShadow = '0 0 10px #22c55e';
                timeEl.innerText = "Connected! Awaiting data...";
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                timeEl.innerText = `Live | ${data.timestamp}`;

                if (data.summary) {
                    document.getElementById('pos-stat').innerText = `${data.summary.pos_count} | ${data.summary.pos_weight}%`;
                    document.getElementById('neg-stat').innerText = `${data.summary.neg_count} | ${data.summary.neg_weight}%`;
                    document.getElementById('neu-stat').innerText = `${data.summary.neu_count} | ${data.summary.neu_weight}%`;
                }
                
                window.lastData = data;
                renderData(data);
            };
            
            function renderData(data) {
                let bestTrades = [];
                data.indices.forEach(idx => {
                    idx.rows.forEach(row => {
                        if (row.ce_fv !== undefined && row.ce_ltp > 5) {
                            let gap = row.ce_ltp - row.ce_fv;
                            let margin = row.ce_ltp * idx.lot;
                            bestTrades.push({ stock: idx.name, type: 'CE', strike: row.ce_strike, gap: gap, ltp: row.ce_ltp, lot: idx.lot, margin: margin });
                        }
                        if (row.pe_fv !== undefined && row.pe_ltp > 5) {
                            let gap = row.pe_ltp - row.pe_fv;
                            let margin = row.pe_ltp * idx.lot;
                            bestTrades.push({ stock: idx.name, type: 'PE', strike: row.pe_strike, gap: gap, ltp: row.pe_ltp, lot: idx.lot, margin: margin });
                        }
                    });
                });

                bestTrades.sort((a, b) => a.gap - b.gap);
                let top3 = bestTrades.slice(0, 3);
                let minGap = top3.length > 0 ? top3[0].gap : Infinity;

                let html = '';
                if (top3.length > 0) {
                    html += `<div style="background:linear-gradient(45deg, #d97706, #fbbf24); color:#111827; padding:15px; border-radius:10px; margin-bottom:30px; text-align:center; box-shadow:0 0 15px #fbbf24; animation: pulse-gold 1.5s infinite;">`;
                    html += `<h3 style="margin:0 0 10px 0; font-weight:900;">üèÜ AI'S TOP 3 CHEAPEST PREMIUMS IN NIFTY 50 üèÜ</h3>`;
                    html += `<div style="display:flex; justify-content:space-around; font-weight:bold; font-size: 16px;">`;
                    top3.forEach((t, i) => {
                        let rank = i === 0 ? "ü•á" : i === 1 ? "ü•à" : "ü•â";
                        let sign = t.gap > 0 ? "+" : "";
                        html += `<div>${rank} ${t.stock} ${t.strike} ${t.type} @ <span style="font-size: 20px;">FV ${sign}${Math.round(t.gap)}</span><br><span style="font-size:13px; font-weight:600; color: #4b5563;">Capital Req: ‚Çπ${Math.round(t.margin).toLocaleString('en-IN')} (Lot: ${t.lot} √ó ‚Çπ${t.ltp})</span></div>`;
                    });
                    html += `</div></div>`;
                }

                let shouldBeep = false;
                
                let filteredIndices = data.indices;
                if(currentFilter !== 'ALL') {
                    filteredIndices = data.indices.filter(idx => idx.status === currentFilter);
                }
                
                if (filteredIndices.length === 0) {
                    html += `<div style="text-align: center; color: #94a3b8; padding: 20px;">No stocks match the current filter.</div>`;
                }
                
                filteredIndices.forEach(idx => {
                    html += `
                        <table>
                            <tr>
                                <td colspan="11" class="table-title">${idx.name} (Spot: ${idx.spot} | Exp: ${idx.expiry} | Weight: ${idx.weight}% | Lot: ${idx.lot})</td>
                            </tr>
                            <tr>
                                <th>Strikes</th>
                                <th>CE Strike</th><th>CE LTP / FV</th><th>CE Intrinsic</th><th>CE TV</th>
                                <th>PE Strike</th><th>PE LTP / FV</th><th>PE Intrinsic</th><th>PE TV</th>
                                <th>TV Diff (CE-PE)</th><th>FV Diff (CE-PE)</th><th>BIAS</th>
                            </tr>
                    `;

                    idx.rows.forEach(row => {
                        let biasHtml = '-';
                        if (row.bias && row.bias.includes('BUY CE')) {
                            biasHtml = `<span class="buy-ce">${row.bias}</span>`;
                        } else if (row.bias && row.bias.includes('BUY PE')) {
                            biasHtml = `<span class="buy-pe">${row.bias}</span>`;
                        }

                        const uniqueKeyCE = idx.name + '_' + row.ce_strike + '_CE';
                        const uniqueKeyPE = idx.name + '_' + row.pe_strike + '_PE';

                        if (row.ce_tv <= 0) {
                            if (!alertedSet.has(uniqueKeyCE)) { alertedSet.add(uniqueKeyCE); shouldBeep = true; }
                        } else { alertedSet.delete(uniqueKeyCE); }

                        if (row.pe_tv <= 0) {
                            if (!alertedSet.has(uniqueKeyPE)) { alertedSet.add(uniqueKeyPE); shouldBeep = true; }
                        } else { alertedSet.delete(uniqueKeyPE); }

                        let ceTvHtml = row.ce_tv <= 0 ? `<td style="font-weight:bold;" class="highlight-tv">${row.ce_tv} üîî‰π∞</td>` : `<td style="font-weight:bold;">${row.ce_tv}</td>`;
                        let peTvHtml = row.pe_tv <= 0 ? `<td style="font-weight:bold;" class="highlight-tv">${row.pe_tv} üîî‰π∞</td>` : `<td style="font-weight:bold;">${row.pe_tv}</td>`;

                        let ceGap = (row.ce_fv !== undefined) ? (row.ce_ltp - row.ce_fv) : Infinity;
                        let peGap = (row.pe_fv !== undefined) ? (row.pe_ltp - row.pe_fv) : Infinity;

                        let isBestCe = (ceGap === minGap && minGap !== Infinity);
                        let isBestPe = (peGap === minGap && minGap !== Infinity);

                        let ceBestIcon = isBestCe ? " üèÜ" : "";
                        let peBestIcon = isBestPe ? " üèÜ" : "";

                        html += `
                            <tr>
                                <td style="font-weight: bold; color: #cbd5e1;">${row.pair}</td>
                                <td class="val-strike">${row.ce_strike}</td>
                                <td class="val-call" style="${isBestCe ? 'background:#d97706; color:#fff; border-radius:5px;' : ''}">${row.ce_ltp} <br><span style="font-size:11px; color:${isBestCe ? '#fff' : '#94a3b8'};">(${row.ce_fv})${ceBestIcon}</span></td>
                                <td>${row.ce_iv}</td>${ceTvHtml}
                                <td class="val-strike">${row.pe_strike}</td>
                                <td class="val-put" style="${isBestPe ? 'background:#d97706; color:#fff; border-radius:5px;' : ''}">${row.pe_ltp} <br><span style="font-size:11px; color:${isBestPe ? '#fff' : '#94a3b8'};">(${row.pe_fv})${peBestIcon}</span></td>
                                <td>${row.pe_iv}</td>${peTvHtml}
                                <td>${row.diff}</td>
                                <td>${row.fv_diff !== undefined ? row.fv_diff : '-'}</td>
                                <td>${biasHtml}</td>
                            </tr>
                        `;
                    });
                    html += `</table>`;
                });

                if (shouldBeep) playBeep();

                container.innerHTML = html;
            };

            ws.onclose = () => {
                timeEl.innerText = "Connection Lost. Retrying...";
                pulse.style.backgroundColor = '#ef4444';
                pulse.style.boxShadow = '0 0 10px #ef4444';
                errorBanner.style.display = 'block';
                setTimeout(connectWebSocket, 3000);
            };
        };

        // Start connection
        connectWebSocket();
    </script>
</body>

</html>